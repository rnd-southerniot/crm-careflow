# CRM-Careflow ↔ LoRaWAN Manager Integration

## Overview

When an OnboardingTask reaches `READY_FOR_INSTALLATION` status, CRM-Careflow sends a webhook to LoRaWAN Manager to automatically provision:
- **Tenant** (from clientName)
- **Application** (from productName)
- **Device Profile** (standard OTAA for specified region)
- **Devices** (from deviceProvisionings)
- **Gateways** (optional)

LoRaWAN Manager then creates these entities in ChirpStack (LoRaWAN Network Server).

## Data Flow

```
CRM-Careflow                    LoRaWAN Manager                 ChirpStack
     │                                │                              │
     │  POST /webhooks/crm-careflow/provision                        │
     │  (x-api-key auth)              │                              │
     ├───────────────────────────────▶│                              │
     │                                │   gRPC: Create Tenant        │
     │                                ├─────────────────────────────▶│
     │                                │   gRPC: Create DeviceProfile │
     │                                ├─────────────────────────────▶│
     │                                │   gRPC: Create Application   │
     │                                ├─────────────────────────────▶│
     │                                │   gRPC: Create Devices       │
     │                                ├─────────────────────────────▶│
     │  202 Accepted                  │                              │
     │◀───────────────────────────────┤                              │
     │                                │                              │
```

## Required Modifications for CRM-Careflow

### 1. Database Schema Changes (prisma/schema.prisma)

#### Add LoRaWAN fields to DeviceProvisioning
```prisma
model DeviceProvisioning {
  // ... existing fields ...

  // LoRaWAN credentials (optional - can be auto-generated by LoRaWAN Manager)
  devEui            String?   // 16-char hex, e.g., "0102030405060708"
  appKey            String?   // 32-char hex, e.g., "01020304050607080910111213141516"

  // Provisioning status tracking
  lorawanProvisioningStatus  String?   // PENDING, SUCCESS, FAILED
  lorawanProvisioningError   String?   // Error message if failed
  lorawanProvisionedAt       DateTime? // When provisioned in ChirpStack
}
```

#### Add region field to Product (or create ProductLoRaWANConfig)
```prisma
model Product {
  // ... existing fields ...

  // LoRaWAN configuration
  lorawanRegion     String?   // EU868, US915, AU915, AS923, etc.
  isLorawanProduct  Boolean   @default(false)
}
```

#### Add location fields to OnboardingTask (for gateway placement)
```prisma
model OnboardingTask {
  // ... existing fields ...

  // Gateway location (optional)
  latitude    Float?
  longitude   Float?
  altitude    Float?
}
```

#### Add webhook tracking table
```prisma
model WebhookLog {
  id            String   @id @default(cuid())
  taskId        String
  task          OnboardingTask @relation(fields: [taskId], references: [id])

  endpoint      String   // e.g., "lorawan-manager"
  eventType     String   // e.g., "task.ready_for_provisioning"
  payload       Json     // Request payload

  status        String   // PENDING, SENT, SUCCESS, FAILED
  statusCode    Int?     // HTTP response code
  response      Json?    // Response body
  error         String?  // Error message

  sentAt        DateTime?
  respondedAt   DateTime?
  retryCount    Int      @default(0)

  createdAt     DateTime @default(now())

  @@map("webhook_logs")
}
```

### 2. New Backend Module: Webhook Service

Create `backend/src/integrations/lorawan/` module:

#### lorawan.module.ts
```typescript
@Module({
  imports: [PrismaModule, HttpModule],
  providers: [LorawanWebhookService],
  exports: [LorawanWebhookService],
})
export class LorawanModule {}
```

#### lorawan-webhook.service.ts
```typescript
@Injectable()
export class LorawanWebhookService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly httpService: HttpService,
  ) {}

  async sendProvisioningEvent(taskId: string): Promise<void> {
    const task = await this.prisma.onboardingTask.findUnique({
      where: { id: taskId },
      include: {
        product: true,
        deviceProvisionings: { include: { hardware: true } },
        client: true,
      },
    });

    const payload = this.buildProvisioningPayload(task);

    // Log webhook attempt
    const webhookLog = await this.prisma.webhookLog.create({
      data: {
        taskId,
        endpoint: 'lorawan-manager',
        eventType: 'task.ready_for_provisioning',
        payload: payload as any,
        status: 'PENDING',
      },
    });

    try {
      const response = await this.httpService.axiosRef.post(
        `${process.env.LORAWAN_MANAGER_URL}/webhooks/crm-careflow/provision`,
        payload,
        {
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': process.env.LORAWAN_MANAGER_API_KEY,
            'x-request-id': webhookLog.id,
          },
          timeout: 10000,
        },
      );

      await this.prisma.webhookLog.update({
        where: { id: webhookLog.id },
        data: {
          status: 'SUCCESS',
          statusCode: response.status,
          response: response.data,
          sentAt: new Date(),
          respondedAt: new Date(),
        },
      });
    } catch (error) {
      await this.prisma.webhookLog.update({
        where: { id: webhookLog.id },
        data: {
          status: 'FAILED',
          statusCode: error.response?.status,
          error: error.message,
          sentAt: new Date(),
        },
      });
      throw error;
    }
  }

  private buildProvisioningPayload(task: OnboardingTaskWithRelations) {
    return {
      eventType: 'task.ready_for_provisioning',
      taskId: task.id,
      clientName: task.clientName,
      clientAddress: task.clientAddress,
      productName: task.product.name,
      productCode: task.product.code,
      region: task.product.lorawanRegion || 'EU868',
      devices: task.deviceProvisionings
        .filter(d => d.hardware?.category?.name !== 'Gateway')
        .map(d => ({
          id: d.id,
          deviceSerial: d.deviceSerial,
          deviceType: d.deviceType,
          firmwareVersion: d.firmwareVersion,
          hardwareId: d.hardwareId,
          devEui: d.devEui,
          appKey: d.appKey,
          notes: d.notes,
        })),
      gateway: task.deviceProvisionings
        .filter(d => d.hardware?.category?.name === 'Gateway')
        .map(d => ({
          id: d.id,
          deviceSerial: d.deviceSerial,
          deviceType: d.deviceType,
          firmwareVersion: d.firmwareVersion,
          hardwareId: d.hardwareId,
          devEui: d.devEui,
          notes: d.notes,
        }))[0],
      contactEmail: task.clientEmail,
      contactPhone: task.clientPhone,
      latitude: task.latitude,
      longitude: task.longitude,
    };
  }
}
```

### 3. Modify Workflow Service

Update `backend/src/workflow/workflow.service.ts` to trigger webhook:

```typescript
// Add to constructor
constructor(
  // ... existing deps ...
  private readonly lorawanWebhookService: LorawanWebhookService,
) {}

// In updateStatus method, after READY_FOR_INSTALLATION handling:
if (status === TaskStatus.READY_FOR_INSTALLATION) {
  // ... existing QR code generation ...

  // Trigger LoRaWAN provisioning webhook (async, don't block)
  if (existingTask.product.isLorawanProduct) {
    this.lorawanWebhookService.sendProvisioningEvent(id).catch(error => {
      console.error('Failed to send LoRaWAN provisioning webhook:', error);
    });
  }
}
```

### 4. Environment Variables

Add to `backend/.env.example`:
```env
# LoRaWAN Manager Integration
LORAWAN_MANAGER_URL=http://localhost:3002
LORAWAN_MANAGER_API_KEY=your-secure-api-key
```

### 5. Frontend Changes

#### Device Provisioning Form
- Add optional DevEUI and AppKey input fields
- Add validation for hex format (DevEUI: 16 chars, AppKey: 32 chars)
- Show auto-generate option (leave blank for LoRaWAN Manager to generate)

#### Product Form
- Add "LoRaWAN Product" checkbox
- Add "LoRaWAN Region" dropdown (EU868, US915, AU915, AS923, etc.)

#### Task Form / Detail View
- Add latitude/longitude fields for gateway location
- Show LoRaWAN provisioning status
- Show provisioning errors if any

### 6. Hardware Category Setup

Ensure hardware categories distinguish between:
- `Gateway` - LoRaWAN gateways
- `Node` / `Sensor` - LoRaWAN end devices

The webhook service uses the category name to separate devices from gateways.

---

## Data Field Mapping

| CRM-Careflow Field | LoRaWAN Manager Field | ChirpStack Entity |
|-------------------|----------------------|-------------------|
| `clientName` | `clientName` → `tenant.name` | Tenant |
| `product.name` | `productName` → `application.name` | Application |
| `product.code` | `productCode` | Application (tags) |
| `product.lorawanRegion` | `region` | DeviceProfile |
| `deviceProvisioning.id` | `devices[].id` → `crmProvisioningId` | Device (metadata) |
| `deviceProvisioning.deviceSerial` | `devices[].deviceSerial` → `device.name` | Device |
| `deviceProvisioning.devEui` | `devices[].devEui` | Device (DevEUI) |
| `deviceProvisioning.appKey` | `devices[].appKey` | Device Keys |
| `deviceProvisioning.firmwareVersion` | `devices[].firmwareVersion` | Device (tags) |
| `task.id` | `taskId` → `crmTaskId` | Device (metadata) |
| `task.clientEmail` | `contactEmail` | Notifications |
| `task.clientPhone` | `contactPhone` | Notifications |
| `task.latitude` | `latitude` | Gateway |
| `task.longitude` | `longitude` | Gateway |

---

## Migration Steps

1. **Create Prisma migration** for schema changes
2. **Deploy LoRaWAN Manager** with matching API key
3. **Update CRM environment** with LORAWAN_MANAGER_URL and API key
4. **Add hardware categories** (Gateway, Node, Sensor) if not present
5. **Configure products** as LoRaWAN products with regions
6. **Test end-to-end** with a sample task

---

## Testing

### Manual Test
1. Create an OnboardingTask with a LoRaWAN product
2. Progress through workflow to HARDWARE_PREPARED_COMPLETE
3. Advance to READY_FOR_INSTALLATION
4. Check:
   - Webhook log in CRM database
   - LoRaWAN Manager received the event
   - ChirpStack has the tenant/application/devices

### Smoke Test Script
```bash
# Check webhook endpoint is reachable
curl -X POST ${LORAWAN_MANAGER_URL}/webhooks/crm-careflow/provision \
  -H "Content-Type: application/json" \
  -H "x-api-key: ${LORAWAN_MANAGER_API_KEY}" \
  -d '{"eventType": "task.ready_for_provisioning", "taskId": "test", "clientName": "Test", "clientAddress": "Test", "productName": "Test", "productCode": "TEST"}' \
  -w "\nHTTP Status: %{http_code}\n"
```

---

## Error Handling

| Error | Cause | Resolution |
|-------|-------|------------|
| 401 Unauthorized | Invalid API key | Check LORAWAN_MANAGER_API_KEY |
| 404 Not Found | Wrong endpoint URL | Check LORAWAN_MANAGER_URL |
| 422 Validation Error | Missing required fields | Check payload structure |
| 500 Internal Error | LoRaWAN Manager issue | Check LoRaWAN Manager logs |
| Timeout | Network/server issue | Implement retry logic |

---

## References

- LoRaWAN Manager: `/Users/robotics/Documents/claude-projects/lorawan-manager`
- ChirpStack Server: `scomm.southerneleven.com`
- ChirpStack Docs: `https://www.chirpstack.io/docs/`
